---
import { getLangFromUrl } from "@i18n/utils";
import BlogPost from "@layouts/BlogPost.astro";
import { Editor } from "@components/Editing/Editor";
import type { BlogData } from "@lib/types";
import { generateShortNumericId } from "@lib/utils";

const blogId = Astro.url.pathname.split("/").find((id) => /^\d+$/.test(id));
const postId = Astro.url.pathname.split("/").slice(-1)[0];
const editing = Astro.url.searchParams.get("editing");
const thisPostIsNew = Astro.url.pathname.endsWith("/new");

const lang = getLangFromUrl(Astro.url);

let blog = null;
let needsClientData = false;

const cookie = Astro.cookies.get("blogiis");
const blogPosts = cookie ? JSON.parse(decodeURIComponent(cookie.value)) : [];

const blogData = blogPosts.find(
    (blog: { id: string; title: string }) => blog.id === blogId,
);

const postData = blogData?.posts.find(
    (post: { id: string }) => post.id === postId,
);

// Validate required parameters
if (!blogData) {
    return Astro.redirect(`/${lang}`);
} else if (!postData && thisPostIsNew) {
    const newPostId = generateShortNumericId();
    blogData.posts = [...blogData.posts, { id: newPostId, title: "New Post", thisPostIsNew }];
    Astro.cookies.set("blogiis", JSON.stringify(blogPosts), {
        path: "/",
        maxAge: 60 * 60 * 24 * 30,
    });

    return Astro.redirect(`/${lang}/${blogId}/${newPostId}`);
} else if (!postData) {
    return Astro.redirect(`/${lang}/${blogId}`);
}

// Set editing mode
if (editing !== "true" && editing !== "false") {
    // Default to editing mode
    const url = new URL(Astro.url);
    url.searchParams.set("editing", "true");
    return Astro.redirect(url.toString());
}

const isNewPost = postData.thisPostIsNew;

needsClientData = true;
blog = {
    id: blogId,
    title: blogData?.title,
    posts: [postData],
    pubDate: new Date(),
} as BlogData;
---

{
    blog ? (
        <BlogPost {...blog}>
            {editing ? (
                <Editor {isNewPost} {blog} {blogPosts} {editing} {lang} client:load />
            ) : null}
        </BlogPost>
    ) : null
}

<style>
    /* Personalizar o bloco do editor */
    #editorjs {
        background-color: #f9fafb;
        color: #111827;
        border: 2px solid #cbd5e1;
        border-radius: 0.5rem;
    }

    /* Blocos de texto */
    .ce-paragraph {
        font-size: 1rem;
        line-height: 1.6;
        color: #1f2937;
    }

    /* Bot√µes e barra de ferramentas */
    .ce-toolbar__plus,
    .ce-toolbar__settings-btn {
        background-color: #e2e8f0;
        color: #1e293b;
    }

    .ce-toolbar__plus:hover {
        background-color: #cbd5e1;
    }
</style>
