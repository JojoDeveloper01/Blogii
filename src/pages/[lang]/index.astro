---
import Layout from "@layouts/Layout.astro";
import Hero from "@components/Hero.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "@lib/consts";
import { getLangFromUrl } from "@i18n/utils";
import type { BlogData } from "@lib/types";

const lang = getLangFromUrl(Astro.url);
const isAuthorized = false;

// Inicializar blogsData como array vazio
let blogsData: BlogData[] = [];

// Se não estiver autorizado, tentaremos pegar o blog temporário no cliente
---

<Layout title={SITE_TITLE} description={SITE_DESCRIPTION} {lang}>
	<Hero {lang} {isAuthorized} {blogsData} />

	<p>
		Welcome to the official <a href="https://astro.build/">Astro</a>
		blog starter template. This template serves as a lightweight, minimally-styled
		starting point for anyone looking to build a personal website, blog, or portfolio
		with Astro.
	</p>
	<p>
		This template comes with a few integrations already configured in your
		<code>astro.config.mjs</code> file. You can customize your setup with
		<a href="https://astro.build/integrations">Astro Integrations</a> to add
		tools like Tailwind, React, or Vue to your project.
	</p>
	<p>Here are a few ideas on how to get started with the template:</p>
	<ul>
		<li>Edit this page in <code>src/pages/index.astro</code></li>
		<li>
			Edit the site header items in <code
				>src/components/Header.astro</code
			>
		</li>
		<li>
			Add your name to the footer in <code
				>src/components/Footer.astro</code
			>
		</li>
		<li>
			Check out the included blog posts in <code>src/content/blog/</code>
		</li>
		<li>
			Customize the blog post page layout in <code
				>src/layouts/BlogPost.astro</code
			>
		</li>
	</ul>
	<p>
		Have fun! If you get stuck, remember to <a
			href="https://docs.astro.build/"
			>read the docs
		</a> or <a href="https://astro.build/chat">join us on Discord</a> to ask
		questions.
	</p>
	<p>
		Looking for a blog template with a bit more personality? Check out <a
			href="https://github.com/Charca/astro-blog-template"
			>astro-blog-template
		</a> by <a href="https://twitter.com/Charca">Maxi Ferreira</a>.
	</p>
</Layout>

<script>
	import { blogDB } from "@services/indexedDB";
	import { sanitizeString } from "@lib/utils";

	async function updateBlogsList() {
		try {
			const tempBlog = await blogDB.getTempBlog();
			//console.log("Blog temporário carregado:", tempBlog);

			if (tempBlog) {
				const blogsCreatedElement =
					document.getElementById("blogsCreated");
				if (blogsCreatedElement) {
					blogsCreatedElement.style.display = "block";
					const blogsList = blogsCreatedElement.querySelector("ul");
					if (blogsList) {
						const blogTitle = sanitizeString(tempBlog.data.title);
						const blogId = sanitizeString(tempBlog.data.title, 1);

						blogsList.innerHTML = `
							<li class="flex items-center justify-center space-x-2">
								<span class="text-orange-400">&rarr;</span>
								<a href="blog/temp?id=${blogId}&editing=true"
								   class="text-white dark:text-gray-900 hover:text-orange-300 transition-colors duration-200">
									${blogTitle}
								</a>
							</li>
						`;
					}
				}
			}
		} catch (err) {
			console.error("Erro ao atualizar lista de blogs:", err);
		}
	}

	// Atualizar lista ao carregar a página
	updateBlogsList();

	// Atualizar quando houver mudanças no IndexedDB
	window.addEventListener("storage", updateBlogsList);
</script>
