---
import Layout from "./Layout.astro";
import { SITE_TITLE, SITE_DESCRIPTION, signInToPublishBlog } from "@/lib/consts";
import LoginRegister from "@/components/LoginRegister.astro";
import { BlogTitleEditor } from "@/components/Editing/BlogTitleEditor";
import { generateShortNumericId } from "@/lib/utils";
import { getDashboardContextOfTheBlog } from "@/lib/utilsDB";

const idLoginModal = generateShortNumericId();

const ctx = await getDashboardContextOfTheBlog(Astro);
if (ctx.redirect) return Astro.redirect(ctx.redirect);

const { lang, blogId, blogData, user } = ctx;
---

<style>
	/* CSS for sidebar toggle functionality - minimal custom CSS */
	#sidebar-toggle {
		display: none; /* Hide the checkbox */
	}

	/* Custom grid areas for layout */
	@media (max-width: 1023px) {
		.dashboard-layout {
			display: grid;
			grid-template-columns: minmax(0, 1fr);
			grid-template-areas: "sidebar" "content";
		}

		#sidebar {
			grid-area: sidebar;
		}

		#sidebar-toggle:checked ~ .dashboard-container .dashboard-layout {
			grid-template-areas: "content";
		}

		#sidebar-toggle:checked ~ .dashboard-container #sidebar {
			transform: translateX(-100%);
			opacity: 0;
			display: none;
		}

		#sidebar-toggle:checked ~ .dashboard-container #sidebar-toggle-icon {
			transform: rotate(90deg);
		}
	}

	@media (min-width: 1024px) {
		.dashboard-layout {
			display: grid;
			grid-template-columns: minmax(250px, auto) 1fr;
			grid-template-areas: "sidebar content";
			gap: 1.5rem;
		}

		#sidebar {
			grid-area: sidebar;
		}

		#sidebar-toggle:checked ~ .dashboard-container .dashboard-layout {
			grid-template-columns: 0 1fr;
		}

		#sidebar-toggle:checked ~ .dashboard-container #sidebar {
			transform: translateX(-100%);
			opacity: 0;
			width: 0;
			overflow: hidden;
		}

		#sidebar-toggle:checked ~ .dashboard-container #sidebar-toggle-icon {
			transform: rotate(90deg);
		}
	}
</style>

<Layout
	title={SITE_TITLE}
	description={SITE_DESCRIPTION}
	lang={String(lang)}
	hideHeaderFooter={true}
>
	<!-- Hidden checkbox for toggle functionality -->
	<input type="checkbox" id="sidebar-toggle" />

	<!-- Toggle button (visible on all screen sizes) -->
	<label
		for="sidebar-toggle"
		class="absolute top-4 left-4 w-7 h-7 bg-white/30 dark:bg-zinc-700/20 shadow-md border border-gray-100/50 dark:border-gray-200/30 backdrop-blur-sm rounded-full flex items-center justify-center cursor-pointer hover:bg-gray-50/90 dark:hover:bg-gray-700/50 hover:text-primary-600 dark:hover:text-primary-400 transition-all duration-300 z-10 text-gray-700 dark:text-gray-300"
	>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			width="16"
			height="16"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="2"
			stroke-linecap="round"
			stroke-linejoin="round"
			class="size-4 transition-transform duration-300 ease-in-out"
		>
			<polyline points="9 6 15 12 9 18"></polyline>
		</svg>
	</label>

	<section class="mx-auto px-4 py-8 min-h-screen dashboard-container">
		<div class="dashboard-layout transition-all duration-300 ease-in-out">
			<!-- Sidebar/Menu lateral estilizado para combinar com o tema -->
			<aside
				id="sidebar"
				class="w-full lg:w-64 max-w-sm transform transition-transform duration-300 ease-in-out"
			>
				<div
					class="bg-white/30 dark:bg-zinc-700/20 backdrop-blur-md rounded-xl shadow-md border border-gray-100/50 dark:border-gray-800/50 overflow-hidden p-4 sticky top-4"
				>
					<!-- Botão de retorno para home -->
					<a
						href={`/${lang}`}
						class="flex items-center gap-1.5 mb-4 py-1.5 px-3 text-sm text-gray-700 dark:text-gray-200 hover:text-primary dark:hover:text-primary rounded-lg hover:bg-gray-100/50 dark:hover:bg-gray-700/30 transition-all duration-100 ease-in-out group"
					>
						<svg
							class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform duration-200"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
						</svg>
						<span>Go back to Home</span>
					</a>

					<!-- Título do blog atual -->
					<div
						class="mb-4 pb-3 border-b border-gray-200/30 dark:border-gray-200/30"
					>
						<h2
							class="text-lg font-semibold text-gray-800 dark:text-gray-100 truncate"
						>
							{blogData?.title || "Sem título"}
						</h2>
						<p
							class="text-xs text-gray-500 dark:text-gray-400 mt-1"
						>
							ID: {blogId}
						</p>
					</div>

					<!-- Menu de navegação com destaque para página atual -->
					<nav>
						<ul class="space-y-1">
							<li>
								{
									/* Verifica se está na página de posts (sem sufixo após o blogId) */
								}
								{
									Astro.url.pathname.split("/").length <= 3 ||
									!Astro.url.pathname.split("/")[3] ? (
										<a
											href={`/${lang}/dashboard/${blogId}`}
											class="flex items-center gap-2 py-2 px-3 text-white font-medium border-l-4 border-[--secondary]"
										>
											<svg
												class="w-5 h-5"
												xmlns="http://www.w3.org/2000/svg"
												fill="none"
												viewBox="0 0 24 24"
												stroke="currentColor"
											>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
												/>
											</svg>
											<span>Posts</span>
										</a>
									) : (
										<a
											href={`/${lang}/dashboard/${blogId}`}
											class="flex items-center gap-2 py-2 px-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100/70 dark:hover:bg-gray-700/40 dark:hover:text-white rounded-lg"
										>
											<svg
												class="w-5 h-5"
												xmlns="http://www.w3.org/2000/svg"
												fill="none"
												viewBox="0 0 24 24"
												stroke="currentColor"
											>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
												/>
											</svg>
											<span>Posts</span>
										</a>
									)
								}
							</li>
							<li>
								{/* Verifica se está na página de settings */}
								{
									Astro.url.pathname.includes(
										`/${lang}/dashboard/${blogId}/settings`,
									) ? (
										<a
											href={`/${lang}/dashboard/${blogId}/settings`}
											class="flex items-center gap-2 py-2 px-3 dark:text-white font-medium border-l-4 border-[--secondary] transition-colors duration-200"
										>
											<svg
												class="w-5 h-5"
												xmlns="http://www.w3.org/2000/svg"
												fill="none"
												viewBox="0 0 24 24"
												stroke="currentColor"
											>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
												/>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
												/>
											</svg>
											<span>Settings</span>
										</a>
									) : (
										<a
											href={`/${lang}/dashboard/${blogId}/settings`}
											class="flex items-center gap-2 py-2 px-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-100/70 dark:hover:bg-gray-700/40 transition-colors duration-200"
										>
											<svg
												class="w-5 h-5"
												xmlns="http://www.w3.org/2000/svg"
												fill="none"
												viewBox="0 0 24 24"
												stroke="currentColor"
											>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
												/>
												<path
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
												/>
											</svg>
											<span>Settings</span>
										</a>
									)
								}
							</li>
							{
								user && (
									<li>
										{/* Verifica se está na página de analytics */}
										{Astro.url.pathname.includes(
											`/${lang}/dashboard/${blogId}/analytics`,
										) ? (
											<a
												href={`/${lang}/dashboard/${blogId}/analytics`}
												class="flex items-center gap-2 py-2 px-3 rounded-lg bg-gradient-to-r from-[--primary]/20 to-[--secondary]/20 dark:text-[--secondary] font-medium border-l-4 border-[--secondary] transition-colors duration-200"
											>
												<svg
													class="w-5 h-5"
													xmlns="http://www.w3.org/2000/svg"
													fill="none"
													viewBox="0 0 24 24"
													stroke="currentColor"
												>
													<path
														stroke-linecap="round"
														stroke-linejoin="round"
														stroke-width="2"
														d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
													/>
												</svg>
												<span>Analytics</span>
											</a>
										) : (
											<a
												href={`/${lang}/dashboard/${blogId}/analytics`}
												class="flex items-center gap-2 py-2 px-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-100/70 dark:hover:bg-gray-700/40 hover:text-primary dark:hover:text-primary transition-colors duration-200"
											>
												<svg
													class="w-5 h-5"
													xmlns="http://www.w3.org/2000/svg"
													fill="none"
													viewBox="0 0 24 24"
													stroke="currentColor"
												>
													<path
														stroke-linecap="round"
														stroke-linejoin="round"
														stroke-width="2"
														d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
													/>
												</svg>
												<span>Analytics</span>
											</a>
										)}
									</li>
								)
							}
						</ul>
					</nav>
				</div>
			</aside>

			<!-- Conteúdo principal -->
			<div
				class="flex-1 flex flex-col gap-6 transition-all duration-300 ease-in-out"
			>
				<div
					class="flex flex-wrap gap-4 justify-between items-center mt-4 bg-white/30 dark:bg-zinc-700/20 backdrop-blur-md rounded-xl shadow-md border border-gray-100/50 dark:border-gray-800/50 p-4"
				>
					<BlogTitleEditor
						isAuthorized={!!user}
						{blogId}
						initialTitle={blogData?.title || ""}
						client:load
					/>

					{
						!user ? (
							<LoginRegister
								id={idLoginModal}
								message={signInToPublishBlog}
							/>
						) : null
					}
					<button
						onclick={!user
							? `document.getElementById('${idLoginModal}').showModal()`
							: null}
						class="px-5 py-1.5 bg-gradient-to-r from-[--primary] to-[--secondary] text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-2"
					>
						<svg
							class="w-5 h-5"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
							></path>
						</svg>
						Publish
					</button>
				</div>
				<div
					class="bg-white/30 dark:bg-zinc-700/20 backdrop-blur-md rounded-xl shadow-md border border-gray-100/50 dark:border-gray-800/50 overflow-hidden p-6"
				>
					<slot />
				</div>
			</div>
		</div>
	</section>
</Layout>
